#!/bin/bash -exu

touch /acceptance-tests_packaging_was_called
echo '${BOSH_INSTALL_TARGET}' >> /acceptance-tests_packaging_was_called
echo "${BOSH_INSTALL_TARGET}" >> /acceptance-tests_packaging_was_called
echo '${PWD}' >> /acceptance-tests_packaging_was_called
echo "${PWD}" >> /acceptance-tests_packaging_was_called
echo '${GOROOT}' >> /acceptance-tests_packaging_was_called
echo "${GOROOT}" >> /acceptance-tests_packaging_was_called
echo '${GOPATH}' >> /acceptance-tests_packaging_was_called
echo "${GOPATH}" >> /acceptance-tests_packaging_was_called

mkdir -p "${BOSH_INSTALL_TARGET}/src/github.com/cloudfoundry-incubator/etcd-release/src/acceptance-tests/"
cp -R ${PWD}/acceptance-tests/* \
"${BOSH_INSTALL_TARGET}/src/github.com/cloudfoundry-incubator/etcd-release/src/acceptance-tests/"

export GOROOT="$(readlink -nf /var/vcap/packages/golang1.7)"
export GOPATH="${BOSH_INSTALL_TARGET}"
export PATH="${GOROOT}/bin:${PATH}"

go install "github.com/cloudfoundry-incubator/etcd-release/src/acceptance-tests/testing/testconsumer"
go install "github.com/cloudfoundry-incubator/etcd-release/src/acceptance-tests/testing/iptables_agent"

chown vcap:vcap "${BOSH_INSTALL_TARGET}/bin/testconsumer"
chown vcap:vcap "${BOSH_INSTALL_TARGET}/bin/iptables_agent"
